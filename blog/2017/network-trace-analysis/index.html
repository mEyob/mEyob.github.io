<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Misikir Eyob | Exploratory Data Analysis: Capturing and analyzing internet traffic</title>
  <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">

  <link rel="shortcut icon" href="/assets/img/favicon.ico">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="/blog/2017/network-trace-analysis/">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        
        <strong>Misikir</strong> Eyob
    </span>
    

    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

      <div class="trigger">
        <!-- About -->
        <a class="page-link" href="/">about</a>

        <!-- Blog -->
        <a class="page-link" href="/blog/">blog</a>

        <!-- Pages -->
        
          
        
          
        
          
        
          
            <a class="page-link" href="/projects/">projects</a>
          
        
          
            <a class="page-link" href="/publications/">publications</a>
          
        
          
            <a class="page-link" href="/teaching/">teaching</a>
          
        
          
        
          
        

        <!-- CV link -->
        <!-- <a class="page-link" href="/assets/pdf/CV.pdf">vitae</a> -->

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Exploratory Data Analysis: Capturing and analyzing internet traffic</h1>
    <p class="post-meta">January 19, 2017</p>
  </header>

  <article class="post-content">
    <p>This notebook shows how to capture and analyze network traffic on a computer 
connected to the internet or a local area network. <a href="https://www.wireshark.org/">Wireshark</a> 
is a powerful tool to capture IP packets going in/out of the
network card of a computer. By default, Wireshark captures packets destined 
to the host computer. Performing network-wide capture is also possible by toggling 
the promiscuous and/or monitor mode, see <a href="https://wiki.wireshark.org/CaptureSetup/WLAN">this</a> tutorial.
In this demo, we focus on network traffic generated by a single machine (my computer).</p>

<p>To automate the capturing process, Tshark, a version of Wireshark that can be run on a terminal window
is used. The captured data is saved in a csv format, and analyzed using scientific libraries of python.
In summary, the tools required for this demo are:</p>

<blockquote>
  <p>This post uses <em>Tshark</em> (a command line network traffic capturing tool), 
<em>Shell script</em> (to automate the capture in Linux or Mac) and
<em>Python</em> (for scripting, analysis, visualization)</p>
</blockquote>

<p>Lets begin with importing python libraries needed for data analysis</p>

<hr />

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">prettypandas</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">notebook</span></code></pre></figure>

<p>… and adjusting display setting</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s">'whitegrid'</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">({</span> <span class="s">'grid.color'</span><span class="p">:</span> <span class="s">'0.8'</span><span class="p">,</span><span class="s">'grid.linestyle'</span><span class="p">:</span> <span class="s">u'--'</span><span class="p">,})</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="s">'RdBu_r'</span><span class="p">)</span></code></pre></figure>

<h2 id="setting-up-the-capture">Setting up the capture</h2>
<p>Instead of performing one long capture, I have chosen to divide the captures into one hour long intervals.
Traffic data from each of these intervals is saved into a separate file. 
The capture starts at 1pm and ends at 12am. So we should expect 11 files in the capture folder. Here is the bash script:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nv">t</span><span class="o">=</span><span class="k">$(</span>date <span class="nt">-j</span> <span class="nt">-f</span> <span class="s2">"%a %b %d %T %Z %Y"</span> <span class="s2">"</span><span class="sb">`</span>date<span class="sb">`</span><span class="s2">"</span> <span class="s2">"+%s"</span><span class="k">)</span>
tshark <span class="nt">-t</span> r <span class="nt">-a</span> duration:3599 <span class="nt">-e</span> frame.time_relative <span class="nt">-e</span> ip.src <span class="nt">-e</span> tcp.srcport <span class="nt">-e</span> udp.srcport <span class="nt">-e</span> ip.dst <span class="nt">-e</span> tcp.dstport <span class="nt">-e</span> udp.dstport <span class="nt">-e</span> frame.len <span class="nt">-T</span> fields <span class="nt">-E</span> <span class="nv">header</span><span class="o">=</span>y <span class="nt">-E</span> <span class="nv">separator</span><span class="o">=</span>, <span class="o">&gt;&gt;</span> Directory/<span class="k">${</span><span class="nv">t</span><span class="k">}</span>.csv</code></pre></figure>

<p>The first line retrieves the date in date-time format and converts it into <a href="https://en.wikipedia.org/wiki/Unix_time">Unix time</a>.
When this script is run, it starts the tshark program setting the <strong><em>duration</em></strong> option to $3599$ seconds
to capture network traffic for one hour. Next follows an array of arguments telling tshark which columns to
include. More detailed options and description on tshark can be found <a href="https://www.wireshark.org/docs/man-pages/tshark.html">here</a>. At the end of the script, “Directory” should be replaced by a proper directory for the output.</p>

<p>There are a number of ways to divide the capture into smaller chunks.</p>

<ul>
  <li>
    <p>Write a script to run tshark for a fixed interval (say an hour), and use the <a href="https://en.wikipedia.org/wiki/Cron">crontab</a> job scheduler to run the script periodically (esp. for Linux Mac).</p>
  </li>
  <li>
    <p>Using the -b option of tshark</p>
  </li>
</ul>

<p>In this demo, the first option is used.</p>

<p>Let us now list the files in the capture folder</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%ls

    1483873200.csv       1483887600.csv       1483909200.csv
    1483876800.csv       1483898400.csv       TraceAnalysis.ipynb
    1483880400.csv       1483902000.csv       periodic-tshark.sh
    1483884000.csv       1483905600.csv
</code></pre></div></div>

<p>In addition to the <em>periodic-tshark.sh</em> file, which is the script discussed above, there are 9 csv files. Each containing meta data on one hour long traffic.
The file names are Unix timestamp of the 
first second in the corresponding hour. So lets change the first and last csv filenames
to a human readable time…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="k">print</span><span class="p">(</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
        <span class="mi">1483873200</span>
    <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S'</span><span class="p">)</span>
<span class="p">)</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2017-01-08 13:00:00
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
        <span class="mi">1483909200</span>
    <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S'</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2017-01-08 23:00:00
</code></pre></div></div>

<p>Notice that eventhough the capture spanned 11 hours there are only 9 files. The missing files are $1483891200$ and $1483894800$
or in datetime format…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
        <span class="mi">1483891200</span>
    <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S'</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">print</span><span class="p">(</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
        <span class="mi">1483894800</span>
    <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S'</span><span class="p">)</span>
<span class="p">)</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2017-01-08 18:00:00
2017-01-08 19:00:00
</code></pre></div></div>

<p>From 6pm to 8pm the computer was not connected, hence, no internet traffic data collected.</p>

<h2 id="loading-the-data">Loading the data…</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">"frame.time_relative"</span><span class="p">,</span><span class="s">"ip.src"</span><span class="p">,</span><span class="s">"tcp.srcport"</span><span class="p">,</span><span class="s">"udp.srcport"</span><span class="p">,</span><span class="s">"ip.dst"</span><span class="p">,</span><span class="s">"tcp.dstport"</span><span class="p">,</span><span class="s">"udp.dstport"</span><span class="p">,</span><span class="s">"frame.len"</span><span class="p">]</span>

<span class="n">tp</span> <span class="o">=</span> <span class="p">{</span><span class="s">"frame.time_relative"</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span><span class="s">"ip.src"</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s">"tcp.srcport"</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s">"udp.srcport"</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s">"ip.dst"</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
      <span class="s">"tcp.dstport"</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s">"udp.dstport"</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="s">"frame.len"</span><span class="p">:</span><span class="nb">float</span><span class="p">}</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="s">"frame.time_relative"</span><span class="p">:</span><span class="s">"Time"</span><span class="p">,</span> <span class="s">"ip.src"</span><span class="p">:</span><span class="s">"Source IP"</span><span class="p">,</span> <span class="s">"tcp.srcport"</span><span class="p">:</span><span class="s">"Source Port(TCP)"</span><span class="p">,</span>
         <span class="s">"udp.srcport"</span><span class="p">:</span><span class="s">"Source Port (UDP)"</span><span class="p">,</span> <span class="s">"ip.dst"</span><span class="p">:</span><span class="s">"Destination IP"</span><span class="p">,</span> <span class="s">"tcp.dstport"</span><span class="p">:</span><span class="s">"Destination Port(TCP)"</span><span class="p">,</span>
         <span class="s">"udp.dstport"</span><span class="p">:</span><span class="s">"Destination Port (UDP)"</span><span class="p">,</span> <span class="s">"frame.len"</span><span class="p">:</span><span class="s">"Packet Length (Bytes)"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">load_trace</span><span class="p">(</span><span class="n">hour</span><span class="p">):</span> 
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span><span class="o">+</span><span class="s">".csv"</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"Time"</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">'</span><span class="si">%.6</span><span class="s">f'</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">hour</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">df</span></code></pre></figure>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start</span> <span class="o">=</span> <span class="mi">1483873200</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">load_trace</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3600</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.csv'</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load_trace</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3600</span><span class="o">*</span><span class="n">i</span><span class="p">))</span>
        
<span class="n">df</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
</code></pre></div></div>

<center><img src="/assets/img/table.jpg" align="middle" style="width: 700px; height: 200px" /></center>

<p>The DataFrame has 8 Columns:</p>

<ul>
  <li>
    <p><strong>Time:</strong> packet tx/rx time in micro second precision,</p>
  </li>
  <li><strong>Source IP:</strong> Internet address of the sending machine</li>
  <li><strong>Source Port (TCP):</strong> TCP port of the application sending the packet (if TCP is used)</li>
  <li><strong>Source Port (UDP):</strong> UDP port of the application sending the packet (if UDP is used)</li>
  <li><strong>Destination Port (TCP):</strong> TCP port of the application receiving the packet (if TCP is used)</li>
  <li><strong>Destination Port (UDP):</strong> UDP port of the application receiving the packet (if UDP is used)</li>
  <li><strong>Packet Length (Bytes):</strong> size of the packet in bytes</li>
</ul>

<p>Addresses and port numbers, and the size of the captured packet in bytes.</p>

<hr />
<h2 id="traffic-volume">Traffic volume</h2>

<h3 id="traffic-per-hour">Traffic per hour</h3>
<p>One of the first things to do would be to visualize the traffic volume
in different time scales. Below is the aggregate traffic volume per hour.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">per_hr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"Hour"</span><span class="p">,</span> <span class="s">"Traffic"</span><span class="p">])</span>
<span class="n">per_hr</span><span class="p">[</span><span class="s">"Hour"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1483873200</span><span class="p">)</span><span class="o">//</span><span class="mi">3600</span><span class="p">))</span>
<span class="n">per_hr</span><span class="p">[</span><span class="s">"Traffic"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"Packet Length (Bytes)"</span><span class="p">]</span>
<span class="n">per_hr</span> <span class="o">=</span> <span class="n">per_hr</span><span class="o">.</span><span class="n">append</span><span class="p">([{</span><span class="s">"Hour"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s">"Traffic"</span><span class="p">:</span> <span class="mi">0</span><span class="p">},{</span><span class="s">"Hour"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s">"Traffic"</span><span class="p">:</span><span class="mi">0</span><span class="p">}],</span><span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">p</span><span class="o">=</span><span class="n">per_hr</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Hour"</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s">"Traffic"</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">]})</span>

<span class="n">p</span><span class="o">.</span><span class="n">Traffic</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">Traffic</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="mi">1000000</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Hour</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">Traffic</span><span class="p">,</span> <span class="s">'o--'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">"Hours (since the start of capture)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">"Traffic volume (MegaBytes)"</span><span class="p">)</span>
</code></pre></div></div>

<center><img src="/assets/img/perHr.png" align="middle" style="width: 500px; height: 300px" /></center>

<p>The peak occured at the 8th hour. Recalling that the capture is started at 13:00, the 
peak would be at 21-22, when, of course, I started streaming a movie :)</p>

<p>Note that there is no traffic on the 5th and 6th hours.</p>

<h3 id="traffic-per-minute">Traffic per Minute</h3>

<p>The following plot shows the traffic volume per minute in Mega Bytes</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">per_min</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">"Minute"</span><span class="p">,</span> <span class="s">"Traffic"</span><span class="p">])</span>
<span class="n">per_min</span><span class="p">[</span><span class="s">"Minute"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1483873200</span><span class="p">)</span><span class="o">//</span><span class="mi">60</span><span class="p">))</span>
<span class="n">per_min</span><span class="p">[</span><span class="s">"Traffic"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"Packet Length (Bytes)"</span><span class="p">]</span>
<span class="n">p</span><span class="o">=</span><span class="n">per_min</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Minute"</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s">"Traffic"</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">]})</span>
<span class="n">p</span><span class="o">.</span><span class="n">Traffic</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">Traffic</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="mi">1000000</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Minute</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">Traffic</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">"Minutes (since the start of capture)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">"Traffic volume (MegaBytes)"</span><span class="p">)</span>
</code></pre></div></div>

<center><img src="/assets/img/perMin.png" align="middle" style="width: 500px; height: 300px" /></center>

<h3 id="aggregate-traffic">Aggregate traffic</h3>
<p>This section wouldn’t be complete without a single number 
summarizing the aggregate traffic volume…</p>

<p>The amount of data sent/received during the entire 11 hour interval is:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s">"Packet Length (Bytes)"</span><span class="p">])</span><span class="o">/</span><span class="mi">1000000000</span><span class="p">,</span> <span class="s">"GB"</span><span class="p">)</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.829809724 GB
</code></pre></div></div>

<hr />

<h2 id="packet-size">Packet size</h2>

<p>Let us now have a closer look at the packet size information in the “<strong>Packet Length (Bytes)</strong>”
column of the DataFrame.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s">"Packet Length (Bytes)"</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s">'axes'</span><span class="p">)</span>

</code></pre></div></div>

<center><img src="/assets/img/box.png" align="middle" style="width: 500px; height: 300px" /></center>

<p>The Box plot shows that the packets range from $10$s to $1500$ bytes.
This is to be expected as the maximum allowable size (<a href="https://en.wikipedia.org/wiki/Maximum_transmission_unit">MTU</a>)
over Ethernet is 1500 bytes. The <code class="highlighter-rouge">red</code> horizontal line around 100 bytes represents the median size.</p>

<p><a href="https://www.coverfire.com/articles/queueing-in-the-linux-network-stack/">This post</a> discusses the queueing effect of large packets and the trade-off involved in having <strong>large packets</strong> (which induces queueing delay) and <strong>small packets</strong> (which increases
per packet processing workload on the network stack).</p>

<p>The following plots depict the PDF and CDF of packet length distribution. The CDF plot shows that about $40\%$ of the
packets have size larger than $1000$ bytes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#f, axes = plt.subplots(1, 2,figsize=(10, 5))</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s">"Packet Length (Bytes)"</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s">"Packet Length (Bytes)"</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">kde_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">cumulative</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">"PDF"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">"CDF"</span><span class="p">)</span>
</code></pre></div></div>

<center><img src="/assets/img/dist.png" align="middle" style="width: 700px; height: 300px" /></center>

<hr />
<h2 id="finding-the-culprit">Finding the culprit</h2>

<p>Another interesting thing would be to see how much traffic is generated by each website (or application in general). Applications are identified by IP and/or port number. To do this, we need to plot aggregate traffic volume per
source-destination-IP pair. However, in this case it suffices to calculate the aggregate traffic per source IP since the capture is performed on a computer, not on a network element (like a router).</p>

<p>As expected, the traffic per application has a heavy tailed distribution. The bar chart below shows the top 20 IP addresses by traffic volume. IP addresses (x-axis) not shown fully as there is 
no point in doing so.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">per_ip</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"Source IP"</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s">"Packet Length (Bytes)"</span><span class="p">:[</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">]})</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">per_ip</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">(</span><span class="s">"Packet Length (Bytes)"</span><span class="p">,</span><span class="s">"sum"</span><span class="p">),</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span>
<span class="n">p</span><span class="p">[</span><span class="s">"Packet Length (Bytes)"</span><span class="p">,</span><span class="s">"sum"</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s">"Packet Length (Bytes)"</span><span class="p">,</span><span class="s">"sum"</span><span class="p">]</span><span class="o">/</span><span class="mi">1000000</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">"Source IP"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s">"Packet Length (Bytes)"</span><span class="p">,</span><span class="s">"sum"</span><span class="p">],</span><span class="n">palette</span><span class="o">=</span><span class="s">"RdBu_r"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">"Traffic volume (MB)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">"Top 20 IP addresses by traffic volume"</span><span class="p">)</span>
</code></pre></div></div>

<center><img src="/assets/img/topTwenty.png" align="middle" style="width: 500px; height: 300px" /></center>

<p>If one needs to know which application/website corresponds to which IP (or which port numbers),
it can be done by listing the applications that are currently using network/internet connection using:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lsof <span class="nt">-i</span>
</code></pre></div></div>

<hr />
<h2 id="anonymizing-ip-addresses">Anonymizing IP addresses</h2>

<p>Finally, a simple way to anonymize personal data such as IP address…</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_anon</span> <span class="o">=</span> <span class="n">load_trace</span><span class="p">(</span><span class="mi">1483873200</span><span class="p">)</span>
<span class="n">anonymized</span><span class="p">[</span><span class="s">'Source IP'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_anon</span><span class="p">[</span><span class="s">'Source IP'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">hash</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">anonymized</span><span class="p">[</span><span class="s">'Destination IP'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_anon</span><span class="p">[</span><span class="s">'Destination IP'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">hash</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">anonymized</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'anonymized.csv'</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="https://github.com/mEyob/Network-trace-analysis"> The Ipython notebook version of this post is available here</a></p>


  </article>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname  = 'meyob-github-io';
      var disqus_identifier = '/blog/2017/network-trace-analysis';
      var disqus_title      = "Exploratory Data Analysis: Capturing and analyzing internet traffic";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

</div>

      </div>
    </div>

    <footer>

  <div class="wrapper">
    &copy; Copyright 2020 Misikir Eyob.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> 

    
  </div>

</footer>


    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


<!-- Load KaTeX -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js"></script>
<script src="/assets/js/katex.js"></script>




<!-- Include custom icon fonts -->
<link rel="stylesheet" href="/assets/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/assets/css/academicons.min.css">

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-XXXXXXXXX', 'auto');
ga('send', 'pageview');
</script>


  </body>

</html>
